From afce4eb1e3bf4a8967897a38e16219efade26c27 Mon Sep 17 00:00:00 2001
From: Jay Bosamiya <jaybosamiya@gmail.com>
Date: Sun, 18 Jun 2017 22:11:03 +0530
Subject: [PATCH] bpo-30657: Check & prevent integer overflow in
 PyString_DecodeEscape (#2174)

---
 Misc/ACKS              | 1 +
 Misc/NEWS              | 3 +++
 Objects/stringobject.c | 8 +++++++-
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/Misc/ACKS b/Misc/ACKS
index 9c374b7..eefb4c0 100644
--- a/Misc/ACKS
+++ b/Misc/ACKS
@@ -151,6 +151,7 @@ Gregory Bond
 Matias Bordese
 Jonas BorgstrÃ¶m
 Jurjen Bos
+Jay Bosamiya
 Peter Bosch
 Dan Boswell
 Eric Bouck
diff --git a/Misc/NEWS b/Misc/NEWS
index cc2f65b..8cfef66 100644
--- a/Misc/NEWS
+++ b/Misc/NEWS
@@ -26,6 +26,9 @@ What's New in Python 2.7.12 release candidate 1?
 Core and Builtins
 -----------------
 
+- bpo-30657: Fixed possible integer overflow in PyString_DecodeEscape.
+  Patch by Jay Bosamiya.
+
 - Issue #20041: Fixed TypeError when frame.f_trace is set to None.
   Patch by Xavier de Gaye.
 
diff --git a/Objects/stringobject.c b/Objects/stringobject.c
index f2db6da..5614ad9 100644
--- a/Objects/stringobject.c
+++ b/Objects/stringobject.c
@@ -612,7 +612,13 @@ PyObject *PyString_DecodeEscape(const char *s,
     char *p, *buf;
     const char *end;
     PyObject *v;
-    Py_ssize_t newlen = recode_encoding ? 4*len:len;
+    Py_ssize_t newlen;
+    /* Check for integer overflow */
+    if (recode_encoding && (len > PY_SSIZE_T_MAX / 4)) {
+        PyErr_SetString(PyExc_OverflowError, "string is too large");
+        return NULL;
+    }
+    newlen = recode_encoding ? 4*len:len;
     v = PyString_FromStringAndSize((char *)NULL, newlen);
     if (v == NULL)
         return NULL;
-- 
2.14.2

