bug fix for sec bug 2672
[Sec 2672] On some OSes ::1 can be spoofed, bypassing source IP ACLs.

Patch comes from pre-release copy of ntp-4.2.8p1.

Upstream-Status: Backport

Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>

--- a/ntpd/ntp_io.c
+++ b/ntpd/ntp_io.c
@@ -3470,6 +3470,29 @@ read_network_packet(
 		    fd, buflen, stoa(&rb->recv_srcadr)));
 
 	/*
+	** Bug 2672: Some OSes (MacOSX and Linux) don't block spoofed ::1
+	*/
+
+	if (AF_INET6 == itf->family) {
+		DPRINTF(2, ("Got an IPv6 packet, from <%s> (%d) to <%s> (%d)\n",
+			stoa(&rb->recv_srcadr),
+			IN6_IS_ADDR_LOOPBACK(PSOCK_ADDR6(&rb->recv_srcadr)),
+			stoa(&itf->sin),
+			!IN6_IS_ADDR_LOOPBACK(PSOCK_ADDR6(&itf->sin))
+			));
+
+		if (   IN6_IS_ADDR_LOOPBACK(PSOCK_ADDR6(&rb->recv_srcadr))
+		    && !IN6_IS_ADDR_LOOPBACK(PSOCK_ADDR6(&itf->sin))
+		   ) {
+			packets_dropped++;
+			DPRINTF(2, ("DROPPING that packet\n"));
+			freerecvbuf(rb);
+			return buflen;
+		}
+		DPRINTF(2, ("processing that packet\n"));
+	}
+
+	/*
 	 * Got one.  Mark how and when it got here,
 	 * put it on the full list and do bookkeeping.
 	 */
