From 75a828dbb8a001b34fa74ae9f481c5acd15e9c91 Mon Sep 17 00:00:00 2001
From: Dragan Marinkovic <dmarinkovi@sierrawireless.com>
Date: Mon, 18 Nov 2019 15:22:55 -0800
Subject: [PATCH] Do not use real lckpwdf()

shadow utility is using lckpwdf() method from libc. This
represents the problem, because lckpwdf() is storing
/etc/shadow related lock file in /etc, and if /etc is not
writable lock could not be obtain and password change
operation will fail.

The code which does not depend on lckpwdf(), stores
lock file at the location of shadow file. This approach
is much more suitable in cases /etc/ is not writable.

Resolves: LXSWIREF-1617
Related: LXSWIREF-1579
Signed-off-by: Dragan Marinkovic <dmarinkovi@sierrawireless.com>
---
 lib/commonio.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/lib/commonio.c b/lib/commonio.c
index 16fa7e7..9dfb3f8 100644
--- a/lib/commonio.c
+++ b/lib/commonio.c
@@ -417,7 +417,7 @@ int commonio_lock (struct commonio_db *db)
 {
 	int i;
 
-#ifdef HAVE_LCKPWDF
+#if defined(HAVE_LCKPWDF) && !defined(DISABLE_REAL_LCKPWDF)
 	/*
 	 * Only if the system libc has a real lckpwdf() - the one from
 	 * lockpw.c calls us and would cause infinite recursion!
@@ -489,7 +489,7 @@ static void dec_lock_count (void)
 				sssd_flush_cache (SSSD_DB_PASSWD | SSSD_DB_GROUP);
 				nscd_need_reload = false;
 			}
-#ifdef HAVE_LCKPWDF
+#if defined(HAVE_LCKPWDF) && !defined(DISABLE_REAL_LCKPWDF)
 			ulckpwdf ();
 #endif				/* HAVE_LCKPWDF */
 		}
-- 
2.17.1

